name: üñ•Ô∏è Windows RDP 

on: 
  workflow_dispatch:
    inputs:
      os_version:
        description: 'üìÄ Select Operating System / Ch·ªçn H·ªá ƒêi·ªÅu H√†nh'
        required: true
        default: 'Windows Server 2025 (Docker - 4vCPU | 8GB RAM)'
        type: choice
        options: 
          - "Windows Server 2025 (Docker - 4vCPU | 8GB RAM)"
          - "Windows Server 2022 (Docker - 4vCPU | 8GB RAM)"
          - "Windows Server 2019 (Docker - 4vCPU | 8GB RAM)"
          - "Windows Server 2012 (Docker - 4vCPU | 8GB RAM)"
          - "Windows 11 Professional (Docker - 4vCPU | 8GB RAM)"
          - "Windows 10 Professional (Docker - 4vCPU | 8GB RAM)"
      
      language:
        description: 'üåê Language / Ng√¥n ng·ªØ'
        required: true
        default: 'English'
        type: choice
        options:
          - "English"
          - "Ti·∫øng Vi·ªát"

jobs:
  windows-rdp-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: üîß System Initialization / Kh·ªüi t·∫°o h·ªá th·ªëng
        run: |
          sudo apt-get update > /dev/null 2>&1
          
          SELECTED_OS="${{ github.event.inputs.os_version }}"
          
          # Determine Windows Version
          if [[ "$SELECTED_OS" == *"2025"* ]]; then
            VERSION="2025"
            OS_NAME="Windows Server 2025"
          elif [[ "$SELECTED_OS" == *"2022"* ]]; then
            VERSION="2022"
            OS_NAME="Windows Server 2022"
          elif [[ "$SELECTED_OS" == *"2019"* ]]; then
            VERSION="2019"
            OS_NAME="Windows Server 2019"
          elif [[ "$SELECTED_OS" == *"2012"* ]]; then
            VERSION="2012"
            OS_NAME="Windows Server 2012"
          elif [[ "$SELECTED_OS" == *"11"* ]]; then
            VERSION="11"
            OS_NAME="Windows 11 Professional"
          elif [[ "$SELECTED_OS" == *"10"* ]]; then
            VERSION="10"
            OS_NAME="Windows 10 Professional"
          fi
          
          # Create Docker Compose Configuration
          cat <<EOF > docker-compose.yml
          version: "3.9"
          services:
            windows:
              image: dockurr/windows
              container_name: windows_rdp
              privileged: true
              environment:
                VERSION: "$VERSION"
                USERNAME: "Admin"
                PASSWORD: "Window@123456"
                RAM_SIZE: "8G"
                CPU_CORES: "4"
                DISK_SIZE: "60G"
              devices: [ "/dev/kvm" ]
              ports:
                - "3389:3389"
                - "8006:8006"
          EOF
          
          docker compose up -d > /dev/null 2>&1
          
          echo "OS_NAME=$OS_NAME" >> $GITHUB_ENV
          
          # Download Kami Tunnel
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          
          # Start Kami Tunnel for RDP (Port 3389)
          nohup ./kami-tunnel 3389 > kami_tunnel_rdp.log 2>&1 &
          RDP_PID=$!
          echo "RDP Tunnel PID: $RDP_PID"
          
          sleep 5
          
          # Start Kami Tunnel for Web Viewer (Port 8006)
          nohup ./kami-tunnel 8006 > kami_tunnel_web.log 2>&1 &
          WEB_PID=$!
          echo "Web Tunnel PID: $WEB_PID"

      - name: üåê Connection Information / Th√¥ng tin k·∫øt n·ªëi
        run: |
          LANG="${{ github.event.inputs.language }}"
          
          if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
            echo "üîÑ ƒêang thi·∫øt l·∫≠p k·∫øt n·ªëi ƒë·∫øn $OS_NAME..."
          else
            echo "üîÑ Establishing connection to $OS_NAME..."
          fi
          echo ""
          
          # Get RDP IP (Port 3389)
          if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
            echo "‚è≥ ƒêang ch·ªù RDP tunnel (C·ªïng 3389)..."
          else
            echo "‚è≥ Waiting for RDP tunnel (Port 3389)..."
          fi
          
          RDP_PUBLIC_IP=""
          RDP_RETRY=0
          
          while [ -z "$RDP_PUBLIC_IP" ] && [ $RDP_RETRY -lt 60 ]; do
            if [ -f kami_tunnel.txt ]; then
              RDP_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | head -1)
              if [[ "$RDP_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
                RDP_PUBLIC_IP="$RDP_CONTENT"
                if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
                  echo "‚úÖ ƒê√£ l·∫•y IP c√¥ng khai RDP: $RDP_PUBLIC_IP"
                else
                  echo "‚úÖ RDP Public IP captured: $RDP_PUBLIC_IP"
                fi
                break
              fi
            fi
            sleep 3
            RDP_RETRY=$((RDP_RETRY + 1))
          done
          
          if [ -z "$RDP_PUBLIC_IP" ]; then
            if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
              echo "‚ùå L·ªñI: Kh√¥ng th·ªÉ l·∫•y IP c√¥ng khai RDP"
            else
              echo "‚ùå ERROR: Could not retrieve RDP Public IP"
            fi
            exit 1
          fi
          
          # Get Web Viewer IP (Port 8006)
          if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
            echo "‚è≥ ƒêang ch·ªù Web tunnel (C·ªïng 8006)..."
          else
            echo "‚è≥ Waiting for Web tunnel (Port 8006)..."
          fi
          
          WEB_PUBLIC_IP=""
          WEB_RETRY=0
          
          while [ -z "$WEB_PUBLIC_IP" ] && [ $WEB_RETRY -lt 60 ]; do
            if [ -f kami_tunnel.txt ]; then
              WEB_CONTENT=$(cat kami_tunnel.txt 2>/dev/null | tail -1)
              if [[ "$WEB_CONTENT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]] && [ "$WEB_CONTENT" != "$RDP_PUBLIC_IP" ]; then
                WEB_PUBLIC_IP="$WEB_CONTENT"
                if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
                  echo "‚úÖ ƒê√£ l·∫•y IP c√¥ng khai Web: $WEB_PUBLIC_IP"
                else
                  echo "‚úÖ Web Public IP captured: $WEB_PUBLIC_IP"
                fi
                break
              fi
            fi
            sleep 3
            WEB_RETRY=$((WEB_RETRY + 1))
          done
          
          if [ -z "$WEB_PUBLIC_IP" ]; then
            if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
              echo "‚ùå L·ªñI: Kh√¥ng th·ªÉ l·∫•y IP c√¥ng khai Web"
            else
              echo "‚ùå ERROR: Could not retrieve Web Public IP"
            fi
            exit 1
          fi
          
          # Display Connection Information
          echo ""
          if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
            echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
            echo "‚ïë              ‚úÖ $OS_NAME - S·∫¥N S√ÄNG K·∫æT N·ªêI"
            echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïë  üñ•Ô∏è  K·∫æT N·ªêI REMOTE DESKTOP (RDP)                                     ‚ïë"
            echo "‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë"
            echo "‚ïë  üåê  IP C√¥ng khai   : $RDP_PUBLIC_IP"
            echo "‚ïë  üë§  T√†i kho·∫£n      : Admin                                           ‚ïë"
            echo "‚ïë  üîê  M·∫≠t kh·∫©u       : Window@123456                                   ‚ïë"
            echo "‚ïë  üìç  C·ªïng RDP       : 3389                                            ‚ïë"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïë  üåê  TR√åNH XEM WEB (Theo d√µi c√†i ƒë·∫∑t)                                 ‚ïë"
            echo "‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë"
            echo "‚ïë  üîó  ƒê·ªãa ch·ªâ Web    : http://$WEB_PUBLIC_IP"
            echo "‚ïë  üìç  C·ªïng           : 8006                                            ‚ïë"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïë  üíª  T√ÄI NGUY√äN H·ªÜ TH·ªêNG                                              ‚ïë"
            echo "‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë"
            echo "‚ïë  ‚ö°  CPU            : 4 vCPU                                          ‚ïë"
            echo "‚ïë  üß†  RAM            : 8GB                                             ‚ïë"
            echo "‚ïë  üíæ  L∆∞u tr·ªØ        : 60GB                                            ‚ïë"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
            echo ""
            echo "üí° M·∫∏O: D√πng Web Viewer ƒë·ªÉ theo d√µi ti·∫øn tr√¨nh c√†i ƒë·∫∑t Windows!"
          else
            echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
            echo "‚ïë              ‚úÖ $OS_NAME - READY FOR CONNECTION"
            echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïë  üñ•Ô∏è  REMOTE DESKTOP CONNECTION (RDP)                                  ‚ïë"
            echo "‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë"
            echo "‚ïë  üåê  Public IP      : $RDP_PUBLIC_IP"
            echo "‚ïë  üë§  Username       : Admin                                           ‚ïë"
            echo "‚ïë  üîê  Password       : Window@123456                                   ‚ïë"
            echo "‚ïë  üìç  RDP Port       : 3389                                            ‚ïë"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïë  üåê  WEB VIEWER (Monitor Installation)                                ‚ïë"
            echo "‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë"
            echo "‚ïë  üîó  Web Address    : http://$WEB_PUBLIC_IP"
            echo "‚ïë  üìç  Port           : 8006                                            ‚ïë"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïë  üíª  SYSTEM RESOURCES                                                 ‚ïë"
            echo "‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë"
            echo "‚ïë  ‚ö°  CPU            : 4 vCPU                                          ‚ïë"
            echo "‚ïë  üß†  RAM            : 8GB                                             ‚ïë"
            echo "‚ïë  üíæ  Storage        : 60GB                                            ‚ïë"
            echo "‚ïë                                                                       ‚ïë"
            echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
            echo ""
            echo "üí° TIP: Use Web Viewer to monitor Windows installation progress!"
          fi
          echo ""
          
          echo "RDP_PUBLIC_IP=$RDP_PUBLIC_IP" >> $GITHUB_ENV
          echo "WEB_PUBLIC_IP=$WEB_PUBLIC_IP" >> $GITHUB_ENV
          # Send connection info to Cloudflare Worker webhook (so FE can fetch it securely)
          # Required secrets in repo: WEBHOOK_URL, WEBHOOK_SECRET
          if [ -n "${{ secrets.WEBHOOK_URL }}" ] && [ -n "${{ secrets.WEBHOOK_SECRET }}" ]; then
            JSON_PAYLOAD=$(cat <<JSON
{"run_id":"${{ github.run_id }}","os_name":"$OS_NAME","rdp":"$RDP_PUBLIC_IP","web":"http://$WEB_PUBLIC_IP","username":"Admin","password":"Window@123456"}
JSON
            )
            curl -sS -X POST "${{ secrets.WEBHOOK_URL }}/api/webhook/connection"               -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}"               -H "Content-Type: application/json"               --data "$JSON_PAYLOAD" >/dev/null || true
          fi


      - name: ‚è∞ Session Keepalive / Duy tr√¨ phi√™n
        run: |
          LANG="${{ github.event.inputs.language }}"
          END_TIME=$(($(date +%s) + 21600))
          
          while [ $(date +%s) -lt $END_TIME ]; do
            REMAINING=$(( ($END_TIME - $(date +%s)) / 60 ))
            HOURS=$(($REMAINING / 60))
            MINUTES=$(($REMAINING % 60))
            
            if [ "$LANG" = "Ti·∫øng Vi·ªát" ]; then
              echo -ne "\rüü¢ $OS_NAME ƒêang ho·∫°t ƒë·ªông | C√≤n l·∫°i: ${HOURS}h ${MINUTES}m | RDP: $RDP_PUBLIC_IP | Web: http://$WEB_PUBLIC_IP     "
            else
              echo -ne "\rüü¢ $OS_NAME Active | Remaining: ${HOURS}h ${MINUTES}m | RDP: $RDP_PUBLIC_IP | Web: http://$WEB_PUBLIC_IP     "
            fi
            
            sleep 30
          done
          echo ""
